include config.env

webpack_image = tetafro/webpack:8
manage = /srv/smart_manage.py
compose_file = docker-compose-dev.yml

.PHONY: build
build:
	# Install NPM packets
	docker run --rm -it \
		-v $(CURDIR)/project/public/js:/app \
		--entrypoint npm \
		$(webpack_image) \
		install
	# Build images and make containers
	docker-compose -f $(compose_file) build
	docker-compose -f $(compose_file) up --no-start
	# Prepare database
	docker-compose -f $(compose_file) run --rm backend $(manage) migrate
	docker-compose -f $(compose_file) run --rm backend $(manage) loaddata \
		/srv/apps/users/fixtures/roles.json \
		/srv/apps/users/fixtures/admin.json \
		/srv/apps/admin/fixtures/settings.json

.PHONY: run
run:
	docker-compose -f $(compose_file) up

.PHONY: stop
stop:
	docker-compose -f $(compose_file) stop

.PHONY: clear
clear:
	docker-compose -f $(compose_file) down
	docker volume rm nott_db

.PHONY: makemigrations
makemigrations:
	docker-compose -f $(compose_file) run --rm backend $(manage) \
		makemigrations users notes admin

.PHONY: migrate
migrate:
	docker-compose -f $(compose_file) run --rm backend $(manage) migrate

.PHONY: fixtures
fixtures:
	docker-compose -f $(compose_file) run --rm backend $(manage) loaddata \
		/srv/apps/users/fixtures/roles.json \
		/srv/apps/users/fixtures/admin.json \
		/srv/apps/admin/fixtures/settigs.json

.PHONY: test
test:
	docker-compose -f $(compose_file) run --rm backend $(manage) test
